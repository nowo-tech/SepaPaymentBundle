# Makefile for SEPA Payment Bundle Demo
# Each demo has its own docker-compose.yml and can be run independently

# Define available demos
DEMOS := symfony6 symfony7 symfony8
DEMO_DIRS := $(addprefix demo-,$(DEMOS))

# Helper function to get port from .env file (defaults to 8001)
get-port = $(shell grep -E '^PORT=' $(1)/.env 2>/dev/null | cut -d '=' -f2 || echo "8001")

# Helper function to get demo version name
get-version = $(shell echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/')

.PHONY: help clean test-all test-coverage-all verify-all check-all
.PHONY: $(foreach demo,$(DEMOS),up-$(demo) down-$(demo) install-$(demo) shell-$(demo) logs-$(demo) test-$(demo) test-coverage-$(demo) verify-$(demo))
.PHONY: up down install test shell logs test-coverage verify

# Default target
help:
	@echo "SEPA Payment Bundle - Demo Commands"
	@echo ""
	@echo "Usage: make <target>"
	@echo ""
	@for demo in $(DEMOS); do \
		version=$$(echo $$demo | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
		echo "$$version Demo (Port 8001):"; \
		echo "  up-$$demo        Start $$version demo containers"; \
		echo "  down-$$demo      Stop $$version demo containers"; \
		echo "  install-$$demo   Install dependencies for $$version demo"; \
		echo "  shell-$$demo     Open shell in $$version PHP container"; \
		echo "  logs-$$demo      Show $$version container logs"; \
		echo "  test-$$demo      Run tests for $$version demo"; \
		echo "  test-coverage-$$demo  Run tests with coverage for $$version demo"; \
		echo ""; \
	done
	@echo "Testing:"
	@echo "  test-all           Run tests for all demos"
	@echo "  test-coverage-all  Run tests with coverage for all demos"
	@echo "  verify-all         Verify all demos are running correctly (HTTP 200)"
	@echo ""
	@echo "Generic commands (use with DEMO=<name>):"
	@echo "  up <demo>         Start a specific demo (e.g., make up DEMO=symfony6)"
	@echo "  down <demo>        Stop a specific demo (e.g., make down DEMO=symfony6)"
	@echo "  install <demo>     Install dependencies (e.g., make install DEMO=symfony6)"
	@echo "  test <demo>        Run tests (e.g., make test DEMO=symfony6)"
	@echo "  shell <demo>       Open shell in a specific demo container"
	@echo "  logs <demo>        Show logs of a specific demo"
	@echo ""
	@echo "Other commands:"
	@echo "  clean              Remove vendor and cache from all demos"
	@echo ""

# Generate up targets for each demo
define up-target-template
up-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸš€ Starting $$$$VERSION demo..."; \
	cd demo-$(1) && \
	if [ ! -f .env ]; then cp .env.example .env 2>/dev/null || true; fi && \
	PORT=$$$$(grep "^PORT=" .env 2>/dev/null | cut -d= -f2 | head -1 || echo 8001); \
	echo "ğŸ” Checking port $$$$PORT..."; \
	CONTAINER=$$$$(docker ps --format "{{.Names}}" --filter "publish=$$$$PORT" 2>/dev/null | head -1); \
	if [ -n "$$$$CONTAINER" ]; then \
		echo "âš ï¸  Port $$$$PORT is in use by container: $$$$CONTAINER"; \
		echo "ğŸ›‘ Stopping container $$$$CONTAINER..."; \
		docker stop $$$$CONTAINER 2>/dev/null || true; \
		docker rm $$$$CONTAINER 2>/dev/null || true; \
		echo "âœ… Port $$$$PORT is now free"; \
	fi && \
	docker-compose build && \
	docker-compose up -d && \
	echo "â³ Waiting for demo to be ready..." && \
	sleep 5 && \
	MAX_ATTEMPTS=12; \
	ATTEMPT=1; \
	while [ $$$$ATTEMPT -le $$$$MAX_ATTEMPTS ]; do \
		if curl -s -o /dev/null -w "%{http_code}" http://localhost:$$$$PORT | grep -q "200"; then \
			echo "âœ… $$$$VERSION demo is running and responding at http://localhost:$$$$PORT"; \
			exit 0; \
		fi; \
		echo "â³ Attempt $$$$ATTEMPT/$$$$MAX_ATTEMPTS: Waiting for demo to respond..."; \
		sleep 5; \
		ATTEMPT=$$$$((ATTEMPT + 1)); \
	done; \
	echo "âŒ Demo failed to respond after $$$$MAX_ATTEMPTS attempts"; \
	exit 1

down-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸ›‘ Stopping $$$$VERSION demo..."; \
	cd demo-$(1) && docker-compose down

install-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸ“¦ Installing dependencies for $$$$VERSION demo..."; \
	cd demo-$(1) && docker-compose exec php composer install --no-interaction

shell-$(1):
	@cd demo-$(1) && docker-compose exec php sh

logs-$(1):
	@cd demo-$(1) && docker-compose logs -f

test-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸ§ª Running tests for $$$$VERSION demo..."; \
	cd demo-$(1) && docker-compose exec php composer test

test-coverage-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸ“Š Running tests with coverage for $$$$VERSION demo..."; \
	cd demo-$(1) && docker-compose exec php composer test-coverage

verify-$(1):
	@VERSION=$$$$(echo $(1) | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
	echo "ğŸ” Verifying $$$$VERSION demo..."; \
	cd demo-$(1) && \
	if [ ! -f .env ]; then cp .env.example .env 2>/dev/null || true; fi && \
	PORT=$$$$(grep "^PORT=" .env 2>/dev/null | cut -d= -f2 | head -1 || echo 8001); \
	$(MAKE) up-$(1) && \
	if curl -s -o /dev/null -w "%{http_code}" http://localhost:$$$$PORT | grep -q "200"; then \
		echo "âœ… $$$$VERSION demo verified successfully"; \
	else \
		echo "âŒ $$$$VERSION demo verification failed"; \
		exit 1; \
	fi
endef

$(foreach demo,$(DEMOS),$(eval $(call up-target-template,$(demo))))

# Generic commands that work with DEMO variable
up:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make up DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) up-$(DEMO)

down:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make down DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) down-$(DEMO)

install:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make install DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) install-$(DEMO)

test:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make test DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) test-$(DEMO)

test-coverage:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make test-coverage DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) test-coverage-$(DEMO)

shell:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make shell DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) shell-$(DEMO)

logs:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make logs DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) logs-$(DEMO)

verify:
	@if [ -z "$(DEMO)" ]; then \
		echo "âŒ Error: DEMO variable is required. Usage: make verify DEMO=symfony6"; \
		exit 1; \
	fi
	@$(MAKE) verify-$(DEMO)

# Test all demos
test-all:
	@echo "ğŸ§ª Running tests for all demos..."
	@FAILED=0; \
	for demo in $(DEMOS); do \
		echo ""; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		echo "Testing $$demo..."; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if $(MAKE) test-$$demo; then \
			echo "âœ… $$demo tests passed"; \
		else \
			echo "âŒ $$demo tests failed"; \
			FAILED=$$((FAILED + 1)); \
		fi; \
	done; \
	if [ $$FAILED -gt 0 ]; then \
		echo ""; \
		echo "âŒ $$FAILED demo(s) failed tests"; \
		exit 1; \
	else \
		echo ""; \
		echo "âœ… All demos passed tests"; \
	fi

# Test coverage for all demos
test-coverage-all:
	@echo "ğŸ“Š Running tests with coverage for all demos..."
	@FAILED=0; \
	for demo in $(DEMOS); do \
		echo ""; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		echo "Testing $$demo with coverage..."; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if $(MAKE) test-coverage-$$demo; then \
			echo "âœ… $$demo coverage generated"; \
		else \
			echo "âŒ $$demo coverage failed"; \
			FAILED=$$((FAILED + 1)); \
		fi; \
	done; \
	if [ $$FAILED -gt 0 ]; then \
		echo ""; \
		echo "âŒ $$FAILED demo(s) failed coverage"; \
		exit 1; \
	else \
		echo ""; \
		echo "âœ… All demos coverage generated"; \
	fi

# Verify all demos
verify-all:
	@echo "ğŸ” Verifying all demos..."
	@FAILED=0; \
	SUCCESSFUL=0; \
	for demo in $(DEMOS); do \
		echo ""; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		VERSION=$$(echo $$demo | sed 's/symfony/Symfony /' | sed 's/6/6.4/' | sed 's/7/7.0/' | sed 's/8/8.0/'); \
		echo "ğŸ“¦ Processing $$VERSION demo ($$demo)"; \
		echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
		if $(MAKE) verify-$$demo; then \
			SUCCESSFUL=$$((SUCCESSFUL + 1)); \
		else \
			FAILED=$$((FAILED + 1)); \
		fi; \
		$(MAKE) down-$$demo || true; \
	done; \
	echo ""; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	echo "ğŸ“Š Verification Summary"; \
	echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; \
	if [ $$FAILED -gt 0 ]; then \
		echo "âŒ Failed: $$FAILED/$$(echo $(DEMOS) | wc -w)"; \
		echo "âœ… Successful: $$SUCCESSFUL/$$(echo $(DEMOS) | wc -w)"; \
		exit 1; \
	else \
		echo "âœ… Successful: $$SUCCESSFUL/$$(echo $(DEMOS) | wc -w)"; \
		echo "âœ… All demos verified successfully!"; \
	fi

# Clean all demos
clean:
	@echo "ğŸ§¹ Cleaning all demos..."
	@for demo in $(DEMOS); do \
		echo "Cleaning demo-$$demo..."; \
		rm -rf demo-$$demo/vendor; \
		rm -rf demo-$$demo/var; \
		rm -rf demo-$$demo/.phpunit.cache; \
		rm -rf demo-$$demo/coverage; \
		rm -f demo-$$demo/coverage.xml; \
	done
	@echo "âœ… Clean completed"

